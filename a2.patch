From c2d52228e373aa109764760f46737b9a7ffc679e Mon Sep 17 00:00:00 2001
From: Edwin Huallpa <hl7joao@dhcp200.merunorth100.iit.edu>
Date: Wed, 11 Feb 2026 16:22:06 -0600
Subject: [PATCH] Assignment 2: setpriority syscall implemented

---
 Makefile   |  1 +
 defs.h     |  1 +
 proc.c     | 18 ++++++++++++++++++
 proc.h     |  2 ++
 syscall.c  |  2 ++
 syscall.h  |  2 ++
 sysproc.c  | 15 +++++++++++++++
 testprio.c | 21 +++++++++++++++++++++
 user.h     |  1 +
 usys.S     |  2 ++
 10 files changed, 65 insertions(+)
 create mode 100644 testprio.c

diff --git a/Makefile b/Makefile
index 09d790c..a8e7831 100644
--- a/Makefile
+++ b/Makefile
@@ -181,6 +181,7 @@ UPROGS=\
 	_usertests\
 	_wc\
 	_zombie\
+	_testprio\
 
 fs.img: mkfs README $(UPROGS)
 	./mkfs fs.img README $(UPROGS)
diff --git a/defs.h b/defs.h
index 82fb982..26eedc7 100644
--- a/defs.h
+++ b/defs.h
@@ -155,6 +155,7 @@ int             argstr(int, char**);
 int             fetchint(uint, int*);
 int             fetchstr(uint, char**);
 void            syscall(void);
+int             setpriority(int pid, int prio);
 
 // timer.c
 void            timerinit(void);
diff --git a/proc.c b/proc.c
index 806b1b1..ea57539 100644
--- a/proc.c
+++ b/proc.c
@@ -88,6 +88,7 @@ allocproc(void)
 found:
   p->state = EMBRYO;
   p->pid = nextpid++;
+  p->priority = 1;
 
   release(&ptable.lock);
 
@@ -496,6 +497,23 @@ kill(int pid)
   return -1;
 }
 
+int
+setpriority(int pid, int prio)
+{
+  struct proc *p;
+
+  acquire(&ptable.lock);
+  for(p = ptable.proc; p < &ptable.proc[NPROC]; p++){
+    if(p->state != UNUSED && p->pid == pid){
+      p->priority = prio;
+      release(&ptable.lock);
+      return 0;
+    }
+  }
+  release(&ptable.lock);
+  return -1;
+}
+
 //PAGEBREAK: 36
 // Print a process listing to console.  For debugging.
 // Runs when user types ^P on console.
diff --git a/proc.h b/proc.h
index 1647114..d6b294b 100644
--- a/proc.h
+++ b/proc.h
@@ -41,6 +41,7 @@ struct proc {
   char *kstack;                // Bottom of kernel stack for this process
   enum procstate state;        // Process state
   int pid;                     // Process ID
+  int priority;                // 0=high, 1=default, 2=low
   struct proc *parent;         // Parent process
   struct trapframe *tf;        // Trap frame for current syscall
   struct context *context;     // swtch() here to run process
@@ -56,3 +57,4 @@ struct proc {
 //   original data and bss
 //   fixed-size stack
 //   expandable heap
+
diff --git a/syscall.c b/syscall.c
index ee85261..418a82c 100644
--- a/syscall.c
+++ b/syscall.c
@@ -103,6 +103,7 @@ extern int sys_unlink(void);
 extern int sys_wait(void);
 extern int sys_write(void);
 extern int sys_uptime(void);
+extern int sys_setpriority(void);
 
 static int (*syscalls[])(void) = {
 [SYS_fork]    sys_fork,
@@ -126,6 +127,7 @@ static int (*syscalls[])(void) = {
 [SYS_link]    sys_link,
 [SYS_mkdir]   sys_mkdir,
 [SYS_close]   sys_close,
+[SYS_setpriority] sys_setpriority,
 };
 
 void
diff --git a/syscall.h b/syscall.h
index bc5f356..425c591 100644
--- a/syscall.h
+++ b/syscall.h
@@ -20,3 +20,5 @@
 #define SYS_link   19
 #define SYS_mkdir  20
 #define SYS_close  21
+#define SYS_setpriority 22
+
diff --git a/sysproc.c b/sysproc.c
index 0686d29..d59d74b 100644
--- a/sysproc.c
+++ b/sysproc.c
@@ -89,3 +89,18 @@ sys_uptime(void)
   release(&tickslock);
   return xticks;
 }
+
+int
+sys_setpriority(void)
+{
+  int pid, prio;
+
+  if(argint(0, &pid) < 0 || argint(1, &prio) < 0)
+    return -1;
+
+  if(prio < 0 || prio > 2)
+    return -1;
+
+  return setpriority(pid, prio);
+}
+
diff --git a/testprio.c b/testprio.c
new file mode 100644
index 0000000..1571d51
--- /dev/null
+++ b/testprio.c
@@ -0,0 +1,21 @@
+#include "types.h"
+#include "stat.h"
+#include "user.h"
+
+int
+main(int argc, char **argv)
+{
+  int me = getpid();
+
+  printf(1, "my pid=%d\n", me);
+
+  printf(1, "setpriority(me,1) -> %d\n", setpriority(me, 1));
+  printf(1, "setpriority(me,0) -> %d\n", setpriority(me, 0));
+  printf(1, "setpriority(me,2) -> %d\n", setpriority(me, 2));
+
+  printf(1, "setpriority(me,99) -> %d (expect -1)\n", setpriority(me, 99));
+  printf(1, "setpriority(99999,1) -> %d (expect -1)\n", setpriority(99999, 1));
+
+  exit();
+}
+
diff --git a/user.h b/user.h
index 4f99c52..513f323 100644
--- a/user.h
+++ b/user.h
@@ -23,6 +23,7 @@ int getpid(void);
 char* sbrk(int);
 int sleep(int);
 int uptime(void);
+int setpriority(int pid, int prio);
 
 // ulib.c
 int stat(const char*, struct stat*);
diff --git a/usys.S b/usys.S
index 8bfd8a1..753399e 100644
--- a/usys.S
+++ b/usys.S
@@ -29,3 +29,5 @@ SYSCALL(getpid)
 SYSCALL(sbrk)
 SYSCALL(sleep)
 SYSCALL(uptime)
+SYSCALL(setpriority)
+
-- 
2.50.1 (Apple Git-155)

